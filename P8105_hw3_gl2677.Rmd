---
title: "P8105_hw3_gl2677"
author: "Gaotong LIU"
date: "10/5/2019"
output: github_document
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(kableExtra)
library(p8105.datasets)
data("instacart")

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))

```

## Problem 1
There are 1,384,617 observations of 131,209 unique users and 15 vaiables in the `instacart` dataset, where each row is a product from an order. The key variables are the ID and name of product, aisle, department, together with the hour of the day and the day of the week on which the order was placed.

Here is an illstrative example of observations. The first 8 rows are from the same order with ID numerber `1` for the user with ID numerber `112108`. This is the `4`th order this user has placed, and it has been `9` days since the last order. In this order, there are total 8 products. The `1`st product added to cart was `Bulgarian Yogurt` with ID number `49302` from `yogurt` aisle with ID number`120`, `dairy eggs` department with ID number `16`. This producthas been ordered by this user in the past and it was placed on `10` o'clock, `Thursday` this time. 
```{r number of aisle, eval=FALSE}
aisle = instacart %>% 
  group_by(aisle) %>% 
  summarize(n = n()) 
aisle %>% 
  filter(min_rank(desc(n)) == 1)
```
* There are 134 aisles are in the dataset, and `fresh vegetables` are the most items ordered from. 
```{r plot}
instacart %>% 
  mutate(aisle_id = as.character(aisle_id),
         aisle_name_id = paste(aisle, aisle_id, sep = "-")) %>% 
  group_by(aisle_id, aisle_name_id) %>% 
  summarize(n = n()) %>% 
  filter(n > 10000) %>% 
  ungroup %>% 
  mutate(aisle_id = forcats::fct_reorder(aisle_id, n))  %>% 
  ggplot(aes(x = aisle_id, y = n, fill = aisle_name_id)) +
  geom_bar(stat = "identity") +
  viridis::scale_fill_viridis(discrete = TRUE) +
  labs(title = "The number of items ordered in each aisle",
       x = "Aisle-id",
       y = "The number of items",
       fill = "") +
  theme(legend.key.size = unit(0.1, "cm")) +
  guides(fill = guide_legend(nrow = 10, byrow = TRUE))
```

```{r table1}
instacart %>% 
  filter(aisle == c("baking ingredients","dog food care", "packaged vegetables fruits")) %>%
  group_by(product_name, aisle) %>% 
  summarize(n = n()) %>% 
  group_by(aisle) %>% 
  filter(min_rank(desc(n)) <= 3) %>%
  arrange(aisle) %>% 
  ungroup() %>%
  select(-aisle) %>% 
  pivot_wider(names_from = product_name,
              values_from = n) %>% 
  knitr::kable(caption = "The number of times each item is ordered against the three most popular items in each aisle.") %>% 
  add_header_above(c("baking ingredients" = 3,"dog food care" = 3, "packaged vegetables fruits" = 3))
```

```{r table2}
instacart %>% 
  filter(product_name %in% c("Pink Lady Apples","Coffee Ice Cream")) %>%
  group_by(product_name, order_dow) %>% 
  summarize(mean_h = mean(order_hour_of_day)) %>% 
  pivot_wider(names_from = product_name,
              values_from = mean_h) %>% 
  mutate(order_dow = recode(order_dow, `0` = "Sunday",
                            `1` = "Monday",
                            `2` = "Tuesday",
                            `3` = "Wednesday",
                            `4` = "Thursday",
                            `5` = "Friday",
                            `6` = "Saturday")) %>% 
  rename("order day" = order_dow) %>% 
  knitr::kable(digits = 0,
               caption = "The mean hour of the day at which Pink Lady Apples and Coffee Ice Cream are ordered on each day of the week")

```

## Problem 1